name: CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - 'custom-image/**/Dockerfile'
  pull_request:
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  CHARTS_DIR: "charts"
  PACKAGE_PATH: "packages"
  CUSTOM_IMAGE_DIR: "custom-image"
  DOCKER_USERNAME: rprilian
  DOCKER_REGISTRY: docker.io
  HELM_IMAGE: docker.io/rprilian/helm-image:latest

jobs:
  build_custom_images:
    name: Build Custom Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push custom images
        run: |
          for dir in ${CUSTOM_IMAGE_DIR}/*; do
            if [ -d "$dir" ] && [ -f "$dir/Dockerfile" ]; then
              IMAGE_NAME=$(basename $dir)
              IMAGE_TAG="${DOCKER_REGISTRY}/${DOCKER_USERNAME}/${IMAGE_NAME}:latest"
              echo "Building and pushing image: $IMAGE_TAG"
              docker buildx build \
                --platform linux/amd64 \
                --push \
                --tag "$IMAGE_TAG" \
                --cache-from "type=registry,ref=$IMAGE_TAG" \
                --cache-to "type=inline" \
                --file "$dir/Dockerfile" \
                "$dir"
            fi
          done

  build_and_deploy_charts:
    name: Build and Deploy Helm Charts
    runs-on: ubuntu-latest
    needs: build_custom_images
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      (needs.build_custom_images.result == 'success' || needs.build_custom_images.result == 'skipped')
    
    container:
      image: docker.io/rprilian/helm-image:latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Package Helm charts
        run: |
          mkdir -p ${PACKAGE_PATH}
          for dir in ${CHARTS_DIR}/*; do
            if [ -d "$dir" ]; then
              CHART_NAME=$(basename $dir)
              echo "Packaging chart: $CHART_NAME"
              helm package $dir --destination ${PACKAGE_PATH}
            fi
          done

      - name: Upload charts as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts
          path: ${{ env.PACKAGE_PATH }}/*.tgz
          retention-days: 30

      - name: Compute GHCR path (lowercase owner)
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LC=$OWNER_LC" >> $GITHUB_ENV
          echo "OCI_REPO=oci://ghcr.io/$OWNER_LC" >> $GITHUB_ENV

      - name: Login to GHCR for Helm OCI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GITHUB_TOKEN" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push charts to GHCR
        run: |
          found=false
          for chart in "$PACKAGE_PATH"/*.tgz; do
            if [ ! -e "$chart" ]; then
              # glob didn't match anything
              break
            fi
            found=true
            echo "Pushing $chart to $OCI_REPO ..."
            helm push "$chart" "$OCI_REPO"
          done
          if [ "$found" = false ]; then
            echo "No chart packages found in $PACKAGE_PATH; nothing to push."
          fi

