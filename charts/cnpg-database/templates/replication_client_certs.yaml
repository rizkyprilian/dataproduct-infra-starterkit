{{- $rel := .Release }}
{{- if and .Values.replicationClientCerts .Values.replicationClientCerts.enabled }}
{{- with .Values.replicationClientCerts }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $rel.Name }}-pg-client-cert-sa
---
apiVersion: v1
kind: Secret
metadata:
 name: {{ $rel.Name }}-pg-client-cert-sa-token
 annotations:
   kubernetes.io/service-account.name: {{ $rel.Name }}-pg-client-cert-sa # replacement
type: kubernetes.io/service-account-token
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $rel.Name }}-pg-client-replication-cert
  labels:
    cnpg.io/reload: "true"
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: {{ $rel.Name }}-pg-client-replication-cert-issuer
spec:
  vault:
    path: {{ .issuer.vaultPath | default "pki_int_dev_db/sign/replace-this-with-assigned-role-name-in-vault" }}
    server: {{ .issuer.vaultServer | default "https://vault.company.com" }}
    auth:
      kubernetes:
        role: {{ .issuer.kubernetesAuth.role | default "replace-this-with-assigned-role-name-in-vault" }}
        mountPath: {{ .issuer.kubernetesAuth.mountPath | default "/v1/auth/replace-this-with-k8s-auth-mount-path-in-vault" }}
        secretRef:
          name: {{ $rel.Name }}-pg-client-cert-sa-token # replacement
          key: token
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ $rel.Name }}-pg-client-replication-cert
spec:
  secretName: {{ $rel.Name }}-pg-client-replication-cert
  usages:
    - client auth
  commonName: {{ .commonName | default "streaming_replica" }}
  issuerRef:
    name: {{ $rel.Name }}-pg-client-replication-cert-issuer
    kind: Issuer
---
# Use the Vault Client's JWT as the Reviewer JWT
# https://developer.hashicorp.com/vault/docs/auth/kubernetes#use-the-vault-client-s-jwt-as-the-reviewer-jwt
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
   name: {{ $rel.Name }}-pg-client-cert-issuer-tokenreview
roleRef:
   apiGroup: rbac.authorization.k8s.io
   kind: ClusterRole
   name: system:auth-delegator
subjects:
- kind: ServiceAccount
  name: {{ $rel.Name }}-pg-client-cert-sa
  namespace: {{ $rel.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $rel.Name }}-pg-client-cert-issuer
rules:
  - apiGroups: ['']
    resources: ['serviceaccounts/token']
    resourceNames: ["{{ $rel.Name }}-pg-client-cert-sa"]
    verbs: ['create']
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $rel.Name }}-pg-client-cert-issuer
subjects:
  - kind: ServiceAccount
    name: cert-manager
    namespace: cert-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $rel.Name }}-pg-client-cert-issuer
{{- end }}
{{- end }}